`$expr`은 MongoDB 쿼리에서 **같은 도큐먼트(document) 내의 필드끼리 비교**할 수 있게 해주는 강력한 연산자입니다.

일반적인 쿼리는 필드 값을 \*\*정적인 값(static value)\*\*과 비교하지만, `$expr`을 사용하면 필드 값을 **다른 필드의 값**이나 **계산된 결과**와 동적으로 비교할 수 있습니다.

-----

### \#\# `$expr`의 핵심 개념 💡

일반적인 MongoDB `find` 쿼리를 생각해 보세요.

```javascript
// 'inventory' 컬렉션에서 quantity가 20인 도큐먼트 찾기
db.inventory.find({ quantity: 20 })
```

이 쿼리는 `quantity` 필드의 값을 \*\*고정된 값 `20`\*\*과 비교합니다.

하지만 만약 "주문 수량(`ordered`)이 현재 재고(`in_stock`)보다 많은 상품을 찾고 싶다"와 같은 요구사항이 있다면 어떻게 해야 할까요? 두 필드는 같은 도큐먼트 안에 있으며, 도큐먼트마다 그 값이 다릅니다.

이때 `$expr`이 사용됩니다. `$expr`은 쿼리 내에서 **집계 표현식(Aggregation Expression)** 문법을 사용할 수 있게 해줍니다. 이를 통해 같은 도큐먼트 내 필드들을 서로 참조하고 비교하는 것이 가능해집니다.

-----

### \#\# 사용법 및 예시

`$expr`은 `find()` 메소드와 집계 파이프라인의 `$match` 단계에서 모두 사용할 수 있습니다.

#### **예시 1: 두 필드의 값 직접 비교하기**

`monthly_budget` 컬렉션에 각 부서의 예산(`budget`)과 지출(`spent`)이 저장되어 있다고 가정해 보겠습니다.

**[데이터 샘플]**

```json
{ "dept": "Marketing", "budget": 5000, "spent": 4500 },
{ "dept": "Tech", "budget": 7000, "spent": 7500 }, // 👈 지출이 예산을 초과함
{ "dept": "HR", "budget": 3000, "spent": 2000 }
```

**[쿼리]**
지출(`spent`)이 예산(`budget`)을 초과한 모든 부서를 찾고 싶을 때 `$expr`을 사용합니다.

```javascript
db.monthly_budget.find({
  $expr: { $gt: ["$spent", "$budget"] }
})
```

**[쿼리 해설]**

  * `$expr`: 집계 표현식을 사용하겠다고 선언합니다.
  * `$gt`: "Greater Than"의 약자로, 첫 번째 인자가 두 번째 인자보다 큰지 비교하는 연산자입니다.
  * `"$spent"`와 `"$budget"`: 필드 이름 앞에 \*\*`$`\*\*를 붙여 해당 필드의 **값**을 참조합니다. 이 `$` 표시가 매우 중요합니다.

**[결과]**
위 쿼리는 `spent` 필드의 값이 `budget` 필드의 값보다 큰 "Tech" 부서 도큐먼트를 반환합니다.

```json
{ "dept": "Tech", "budget": 7000, "spent": 7500 }
```

-----

### \#\# 좀 더 복잡한 예시 (계산 포함)

`$expr`은 단순 비교뿐만 아니라, 필드 값들을 이용한 연산 결과도 비교할 수 있습니다.

**[데이터 샘플]**
`orders` 컬렉션에 주문 정보가 있고, 가격(`price`)과 수량(`quantity`)의 곱이 할인 기준(`discount_threshold`)을 넘는지 확인하고 싶다고 가정해 봅시다.

```json
{ "item": "pen", "price": 5, "quantity": 20, "discount_threshold": 120 },
{ "item": "notebook", "price": 10, "quantity": 15, "discount_threshold": 140 } // 👈 10 * 15 = 150 > 140
```

**[쿼리]**
`price * quantity`의 결과가 `discount_threshold`보다 큰 주문을 찾습니다.

```javascript
db.orders.find({
  $expr: {
    $gt: [
      { $multiply: ["$price", "$quantity"] }, // 배열의 첫 번째 인자: 계산된 총액
      "$discount_threshold"                  // 배열의 두 번째 인자: 비교할 필드 값
    ]
  }
})
```

**[결과]**
`10 * 15`의 결과인 `150`이 `discount_threshold`인 `140`보다 크므로 "notebook" 주문이 반환됩니다.

-----
