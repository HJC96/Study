좋습니다 🙂 이번 문제를 단순히 “쿼리 암기”가 아니라 개념적으로 이해할 수 있도록 정리해드릴게요.

⸻

MongoDB $lookup + $match + $group 개념 정리

1. $lookup (조인 역할)
	•	SQL의 JOIN과 비슷한 역할
	•	다른 컬렉션에서 조건에 맞는 문서를 찾아와 배열 필드로 합쳐줌
	•	기본 구조:

{
  "$lookup": {
    "from": "<다른 컬렉션 이름>",
    "localField": "<현재 컬렉션 필드>",
    "foreignField": "<조인할 대상 컬렉션 필드>",
    "as": "<결과 배열 이름>"
  }
}

	•	예시:
employees.employee_id 와 salaries.employee_id 를 매칭 → 결과는 employee_salaries 배열에 저장됨.

⸻

2. $unwind (선택적으로 필요)
	•	$lookup 결과는 항상 배열(employee_salaries)로 들어옴
	•	이 배열을 문서 단위로 펼쳐줘야 개별 필드(year, salary)를 기준으로 조건 검색 가능
	•	따라서 $match나 $group 전에 자주 사용됨.

{ "$unwind": "$employee_salaries" }


⸻

3. $match (필터링)
	•	조건을 걸어 원하는 문서만 추림
	•	조인된 배열(employee_salaries)의 특정 필드를 조건으로 걸 수 있음
	•	예시: year가 2021인 급여만 선택

{ "$match": { "employee_salaries.year": 2021 } }


⸻

4. $group (집계)
	•	SQL의 GROUP BY와 유사
	•	특정 키(예: employee_id)로 묶고 합계, 평균 등 집계 연산 수행 가능

{
  "$group": {
    "_id": "$employee_id",
    "total_salary": { "$sum": "$employee_salaries.salary" }
  }
}


⸻

5. 전체 파이프라인 (개념적으로)
	1.	employees 컬렉션 기준 시작
	2.	salaries 컬렉션 조인 ($lookup)
	3.	배열 풀기 ($unwind)
	4.	2021년 급여만 추림 ($match)
	5.	직원별 합산 ($group)

[
  {
    "$lookup": {
      "from": "salaries",
      "localField": "employee_id",
      "foreignField": "employee_id",
      "as": "employee_salaries"
    }
  },
  { "$unwind": "$employee_salaries" },
  { "$match": { "employee_salaries.year": 2021 } },
  {
    "$group": {
      "_id": "$employee_id",
      "total_salary": { "$sum": "$employee_salaries.salary" }
    }
  }
]


⸻

6. 핵심 개념 요약
	•	$lookup: 컬렉션 간 조인 (결과는 배열)
	•	$unwind: 조인 결과 배열을 문서 단위로 분해
	•	$match: 조건 필터링 (특정 연도, 특정 값 등)
	•	$group: 집계 연산 (합계, 평균, 개수 등)

⸻

👉 요약하면,
	•	$lookup은 조인을 위한 도구
	•	$unwind는 배열을 펼쳐서 조건 적용 가능하게 만드는 도구
	•	$match는 조건 필터링
	•	$group은 집계

⸻
